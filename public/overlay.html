<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ë…¸ë˜ ì‹ ì²­ ì˜¤ë²„ë ˆì´</title>
<link rel="stylesheet" href="/style.css"/>
<script src="/socket.io/socket.io.js"></script>
<style>
.small{font-size:12px;color:var(--muted)}

/* ì¸ë¼ì¸ ë¦¬ìŠ¤íŠ¸: ê°€ìš´ë° ì •ë ¬ + í¬ê²Œ */
.list{
  margin-top: 6px;
  display:flex; flex-wrap: wrap; align-items:baseline; justify-content:center;
  align-content:flex-start; /* ê°€ë¡œ ë¨¼ì € ì±„ì›€ */
  gap: 8px 14px;
  font-size: var(--listSize);
}
.item{display:inline; white-space:nowrap; line-height:1.35}
.item .title{font-weight:800}
.item::after{content:" /"; opacity:.45; margin-left:4px}
.item:last-child::after{content:""} /* ë§ˆì§€ë§‰ ìŠ¬ë˜ì‹œ ì œê±° */
.item.done{opacity:.65; text-decoration:line-through}
.item.current .title{
  background: var(--currentBg); border-radius:8px; padding:2px 8px;
}

/* í—¤ë” ì¤‘ì•™ ì •ë ¬ */
.header{
  flex-direction:column; align-items:center; justify-content:center; text-align:center;
}
.header .title{ font-size: var(--titleSize); }

/* pill ê³µí†µ */
.pill{
  display:inline-flex; align-items:center; justify-content:center;
  padding:8px 14px; border-radius:999px; gap:6px;
  font-weight:900; line-height:1;
}
.pill.fill{
  background: var(--pillBg); color:#2d2d2d; border:1px solid rgba(0,0,0,0.03);
}
.pill.ghost{
  background: rgba(255,255,255,0.35); color:#2d2d2d; border:1px solid var(--accent);
}

/* ì§„í–‰/ì‹ ì²­ê³¡ í–‰ */
.metaRow{
  display:flex; align-items:center; gap:12px; margin-top:6px;
  font-size: calc(var(--listSize) * .85);
  justify-content:center;
}
.pill.stat{ min-width:210px; }

/* ë¸Œëœë“œ ë¼ë²¨ */
.brandWrap{ display:flex; justify-content:center; margin-top:8px; }
.brandTag{
  font-size: calc(var(--listSize) * 1.25);
  font-weight: 900;
}
.brandTag.wide{
  padding-left: 56px;
  padding-right: 56px;
}
.divider{height:12px;}
</style>
</head>
<body>
<div class="container center">
  <div class="card fancy">
    <!-- (3) ë°˜íˆ¬ëª… ê³ ì–‘ì´ ì›Œí„°ë§ˆí¬ -->
    <svg class="wm-cat" viewBox="0 0 200 200" aria-hidden="true">
      <circle cx="100" cy="118" r="70"/>
      <polygon points="60,70 90,20 100,72"/>
      <polygon points="140,70 110,20 100,72"/>
      <line x1="70" y1="118" x2="35" y2="110" />
      <line x1="70" y1="124" x2="35" y2="124" />
      <line x1="70" y1="130" x2="35" y2="138" />
      <line x1="130" y1="118" x2="165" y2="110" />
      <line x1="130" y1="124" x2="165" y2="124" />
      <line x1="130" y1="130" x2="165" y2="138" />
    </svg>

    <div class="header">
      <div id="titleEl" class="title">PlayListğŸ’›</div>

      <!-- ë¸Œëœë“œ ë¼ë²¨ -->
      <div class="brandWrap" id="brandWrap">
        <div id="brandTag" class="pill fill brandTag wide">ê²¨ìš¸</div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- ì§„í–‰ / ì‹ ì²­ê³¡ -->
    <div class="metaRow">
      <div class="pill ghost stat">ì§„í–‰ <span id="progNow">0</span> / <span id="progTotal">0</span></div>
      <div class="pill ghost stat">ì‹ ì²­ê³¡ <span id="counter">0</span></div>
    </div>

    <!-- ì¸ë¼ì¸ ë¦¬ìŠ¤íŠ¸ -->
    <div class="list" id="oneList"></div>
    <div class="footer small">ï¼Š ì™„ë£Œëœ ê³¡ì€ íšŒìƒ‰ ì·¨ì†Œì„ ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</div>

<script>
const socket = io();

/* URL íŒŒë¼ë¯¸í„°ë¡œ í…Œë§ˆ/ë¸Œëœë”© ì£¼ì… (ìš”ì²­í•˜ì‹  ìœ ì¼ ì¶”ê°€ì‚¬í•­) */
(function applyQueryTheme(){
  const p = new URLSearchParams(location.search);
  const root = document.documentElement;

  const title = p.get('title');        // í—¤ë” íƒ€ì´í‹€ ë¬¸êµ¬
  const brand = p.get('brand');        // ë¸Œëœë“œ pill í…ìŠ¤íŠ¸
  const accent = p.get('accent');      // #RRGGBB
  const listSize = p.get('listSize');  // ì˜ˆ: 20px
  const titleSize = p.get('titleSize');// ì˜ˆ: 40px
  const wm = p.get('wm');              // ì›Œí„°ë§ˆí¬ opacity(0~0.2 ê¶Œì¥)
  const ring = p.get('ring');          // ë…¸ë€ ë§ ë‘ê»˜(px)
  const showBrand = p.get('showBrand');// "0"ì´ë©´ ë¸Œëœë“œ ìˆ¨ê¹€

  if (title) document.getElementById('titleEl').textContent = title;
  if (brand) document.getElementById('brandTag').textContent = brand;
  if (showBrand === '0') document.getElementById('brandWrap').style.display = 'none';

  if (accent) root.style.setProperty('--accent', accent);
  if (listSize) root.style.setProperty('--listSize', listSize);
  if (titleSize) root.style.setProperty('--titleSize', titleSize);
  if (wm) root.style.setProperty('--wmOpacity', wm);
  if (ring) root.style.setProperty('--ringW', `${parseInt(ring,10)||5}px`);
})();

function el(tag, attrs={}, ...children){
  const node = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => {
    if (k === 'class') node.className = v;
    else if (k === 'html') node.innerHTML = v;
    else node.setAttribute(k, v);
  });
  children.forEach(c => node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
  return node;
}

socket.on('state', (state) => {
  // ì‹ ì²­ê³¡ ì¹´ìš´í„°
  document.getElementById('counter').textContent = state.counter ?? 0;

  // ì§„í–‰/ì „ì²´
  const progNow = (state.sung?.length || 0) + (state.current ? 1 : 0);
  const progTotal = (state.sung?.length || 0) + (state.upcoming?.length || 0) + (state.current ? 1 : 0);
  document.getElementById('progNow').textContent = progNow;
  document.getElementById('progTotal').textContent = progTotal;

  // cap ì‚¬ìš© ì œê±°: ì™„ë£Œ -> í˜„ì¬ -> ëŒ€ê¸° ì „ì²´ ë…¸ì¶œ
  const currentArr = state.current ? [{...state.current, _status:'current'}] : [];
  const upcoming   = (state.upcoming || []).map(s => ({...s, _status:'pending'}));
  const sung       = (state.sung || []).map(s => ({...s, _status:'done'}));
  const all = [...sung, ...currentArr, ...upcoming];

  // ë Œë”
  const list = document.getElementById('oneList');
  list.innerHTML = '';
  if (!all.length){
    list.appendChild(el('span', {class:'small'}, 'í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'));
    return;
  }

  all.forEach(s => {
    const item = el('span', {class:`item ${s._status==='done'?'done':''} ${s._status==='current'?'current':''}`},
      el('span', {class:'title'}, s.title)
    );
    list.appendChild(item);
  });
});
</script>
</body>
</html>
